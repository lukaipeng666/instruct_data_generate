<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ç”Ÿæˆä»»åŠ¡ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        label .required {
            color: #e74c3c;
            margin-left: 4px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: white;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
        }

        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #e74c3c;
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            background: #c0392b;
        }

        .btn-stop:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-section {
            margin-top: 30px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-running {
            background: #3498db;
            color: white;
        }

        .status-finished {
            background: #27ae60;
            color: white;
        }

        .status-error {
            background: #e74c3c;
            color: white;
        }

        .output-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .output-line {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .output-line.error {
            color: #f48771;
        }

        .output-line.success {
            color: #4ec9b0;
        }

        .output-line.info {
            color: #569cd6;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .alert-success {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
        }

        .services-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .service-item {
            display: flex;
            gap: 10px;
        }

        .service-item input {
            flex: 1;
        }

        .btn-add-service {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-remove-service {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ æ•°æ®ç”Ÿæˆä»»åŠ¡ç®¡ç†</h1>
            <p>é…ç½®å¹¶è¿è¡Œåˆ†å¸ƒå¼æ•°æ®ç”Ÿæˆä»»åŠ¡</p>
        </div>

        <div class="content">
            <div id="alert-container"></div>

            <form id="task-form">
                <!-- åŸºç¡€é…ç½® -->
                <div class="form-section">
                    <h2>ğŸ“‹ åŸºç¡€é…ç½®</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>è¾“å…¥æ–‡ä»¶è·¯å¾„ <span class="required">*</span></label>
                            <input type="text" id="input_file" name="input_file" required 
                                   placeholder="/path/to/input.jsonl">
                            <div class="help-text">è¾“å…¥çš„æ ·æœ¬JSONLæ–‡ä»¶è·¯å¾„</div>
                        </div>

                        <div class="form-group">
                            <label>è¾“å‡ºæ–‡ä»¶è·¯å¾„ <span class="required">*</span></label>
                            <input type="text" id="output" name="output" required 
                                   placeholder="/path/to/output.jsonl">
                            <div class="help-text">è¾“å‡ºçš„JSONLæ–‡ä»¶è·¯å¾„</div>
                        </div>

                        <div class="form-group">
                            <label>æ¨¡å‹è·¯å¾„</label>
                            <input type="text" id="model" name="model" 
                                   value="/data/kaipeng/model/Qwen/Qwen3-235B-A22B-Instruct-2507"
                                   placeholder="/data/kaipeng/model/Qwen/Qwen3-235B-A22B-Instruct-2507">
                            <div class="help-text">æ¨¡å‹åç§°æˆ–è·¯å¾„</div>
                        </div>
                    </div>
                </div>

                <!-- æœåŠ¡é…ç½® -->
                <div class="form-section">
                    <h2>ğŸ”Œ æœåŠ¡é…ç½®</h2>
                    <div class="form-group full-width">
                        <label>APIæœåŠ¡åœ°å€</label>
                        <div class="services-input" id="services-container">
                            <div class="service-item">
                                <input type="text" class="service-input" 
                                       value="http://localhost:6466/v1"
                                       placeholder="http://localhost:6466/v1">
                                <button type="button" class="btn-remove-service" onclick="removeService(this)" style="display:none;">åˆ é™¤</button>
                            </div>
                        </div>
                        <button type="button" class="btn-add-service" onclick="addService()">+ æ·»åŠ æœåŠ¡</button>
                        <div class="help-text">å¯ä»¥æ·»åŠ å¤šä¸ªAPIæœåŠ¡åœ°å€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…ä»»åŠ¡</div>
                    </div>
                </div>

                <!-- ä»»åŠ¡å‚æ•° -->
                <div class="form-section">
                    <h2>âš™ï¸ ä»»åŠ¡å‚æ•°</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>æ‰¹å¤„ç†å¤§å°</label>
                            <input type="number" id="batch_size" name="batch_size" 
                                   value="16" min="1" placeholder="16">
                            <div class="help-text">æ¯ä¸ªæœåŠ¡çš„æ‰¹å¤„ç†å¤§å°ï¼Œé»˜è®¤: 16</div>
                        </div>

                        <div class="form-group">
                            <label>æœ€å¤§å¹¶å‘æ•°</label>
                            <input type="number" id="max_concurrent" name="max_concurrent" 
                                   value="16" min="1" placeholder="16">
                            <div class="help-text">æ¯ä¸ªæœåŠ¡çš„æœ€å¤§å¹¶å‘æ•°ï¼Œé»˜è®¤: 16</div>
                        </div>

                        <div class="form-group">
                            <label>æœ€ä½è¯„åˆ†</label>
                            <input type="number" id="min_score" name="min_score" 
                                   value="10" min="0" max="10" placeholder="10">
                            <div class="help-text">æœ€ä½è¯„åˆ†è¦æ±‚(0-10)ï¼Œé»˜è®¤: 10</div>
                        </div>

                        <div class="form-group">
                            <label>ä»»åŠ¡ç±»å‹</label>
                            <select id="task_type" name="task_type">
                                <option value="general">general</option>
                            </select>
                            <div class="help-text">é»˜è®¤: general</div>
                        </div>

                        <div class="form-group">
                            <label>æ¯ä¸ªæ ·æœ¬çš„å˜ä½“æ•°é‡</label>
                            <input type="number" id="variants_per_sample" name="variants_per_sample" 
                                   value="3" min="1" placeholder="3">
                            <div class="help-text">é»˜è®¤: 3</div>
                        </div>

                        <div class="form-group">
                            <label>æ•°æ®ä½¿ç”¨è½®æ¬¡</label>
                            <input type="number" id="data_rounds" name="data_rounds" 
                                   value="10" min="1" placeholder="10">
                            <div class="help-text">é»˜è®¤: 10</div>
                        </div>

                        <div class="form-group">
                            <label>é‡è¯•æ¬¡æ•°</label>
                            <input type="number" id="retry_times" name="retry_times" 
                                   value="3" min="0" placeholder="3">
                            <div class="help-text">é»˜è®¤: 3</div>
                        </div>
                    </div>
                </div>

                <!-- æç¤ºè¯é…ç½® -->
                <div class="form-section">
                    <h2>ğŸ’¬ æç¤ºè¯é…ç½®</h2>
                    <div class="form-group full-width">
                        <label>ç‰¹æ®Šä»»åŠ¡æç¤ºè¯</label>
                        <textarea id="special_prompt" name="special_prompt" 
                                  placeholder="è¯·è¾“å…¥ç‰¹æ®Šä»»åŠ¡æç¤ºè¯ï¼ˆå¯é€‰ï¼‰..."></textarea>
                        <div class="help-text">ç”¨äºæŒ‡å¯¼æ¨¡å‹ç”Ÿæˆç‰¹å®šæ ¼å¼æˆ–å†…å®¹çš„ä»»åŠ¡æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</div>
                    </div>

                    <div class="form-group full-width">
                        <label>é¢˜ææ–¹å‘</label>
                        <input type="text" id="directions" name="directions" 
                               value="ä¿¡ç”¨å¡å¹´è´¹ è‚¡ç¥¨çˆ†ä»“ åŸºé‡‘èµå›"
                               placeholder="ä¿¡ç”¨å¡å¹´è´¹ è‚¡ç¥¨çˆ†ä»“ åŸºé‡‘èµå›">
                        <div class="help-text">éœ€è¦æ„é€ çš„é¢˜æï¼Œå¤šä¸ªé¢˜æç”¨ç©ºæ ¼åˆ†éš”ï¼Œé»˜è®¤: ä¿¡ç”¨å¡å¹´è´¹ è‚¡ç¥¨çˆ†ä»“ åŸºé‡‘èµå›</div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="button-group">
                    <button type="submit" class="btn-primary" id="start-btn">ğŸš€ å¯åŠ¨ä»»åŠ¡</button>
                    <button type="button" class="btn-stop" id="stop-btn" disabled>â¹ï¸ åœæ­¢ä»»åŠ¡</button>
                </div>
            </form>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="progress-section" id="progress-section">
                <div class="progress-header">
                    <h2>ğŸ“Š ä»»åŠ¡è¿›åº¦</h2>
                    <span class="status-badge" id="status-badge">è¿è¡Œä¸­</span>
                </div>
                <div class="output-container" id="output-container"></div>
            </div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let eventSource = null;

        // æ·»åŠ æœåŠ¡åœ°å€è¾“å…¥æ¡†
        function addService() {
            const container = document.getElementById('services-container');
            const newItem = document.createElement('div');
            newItem.className = 'service-item';
            newItem.innerHTML = `
                <input type="text" class="service-input" 
                       value="http://localhost:6466/v1"
                       placeholder="http://localhost:6466/v1">
                <button type="button" class="btn-remove-service" onclick="removeService(this)">åˆ é™¤</button>
            `;
            container.appendChild(newItem);
            updateRemoveButtons();
        }

        // åˆ é™¤æœåŠ¡åœ°å€è¾“å…¥æ¡†
        function removeService(btn) {
            const container = document.getElementById('services-container');
            if (container.children.length > 1) {
                btn.parentElement.remove();
                updateRemoveButtons();
            }
        }

        // æ›´æ–°åˆ é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateRemoveButtons() {
            const container = document.getElementById('services-container');
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const removeBtn = items[i].querySelector('.btn-remove-service');
                if (removeBtn) {
                    removeBtn.style.display = items.length > 1 ? 'block' : 'none';
                }
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'error') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // æ ¼å¼åŒ–JSONå­—ç¬¦ä¸²
        function formatJSON(text) {
            try {
                let formatted = text;
                
                // å¤„ç†JSONä»£ç å—
                const jsonBlockRegex = /```json\s*([\s\S]*?)```/g;
                formatted = formatted.replace(jsonBlockRegex, (match, jsonContent) => {
                    try {
                        const trimmed = jsonContent.trim();
                        // è§£æJSON
                        const parsed = JSON.parse(trimmed);
                        // æ ¼å¼åŒ–JSONï¼ˆ2ç©ºæ ¼ç¼©è¿›ï¼‰
                        const formattedJSON = JSON.stringify(parsed, null, 2);
                        return '```json\n' + formattedJSON + '\n```';
                    } catch (e) {
                        // è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤å¸¸è§çš„JSONé—®é¢˜
                        try {
                            // å°è¯•ä½¿ç”¨æ›´å®½æ¾çš„è§£æ
                            let cleaned = trimmed;
                            // ç§»é™¤å¯èƒ½çš„BOMæ ‡è®°
                            cleaned = cleaned.replace(/^\uFEFF/, '');
                            const parsed = JSON.parse(cleaned);
                            const formattedJSON = JSON.stringify(parsed, null, 2);
                            return '```json\n' + formattedJSON + '\n```';
                        } catch (e2) {
                            // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œè¿”å›åŸå†…å®¹
                            return match;
                        }
                    }
                });
                
                return formatted;
            } catch (e) {
                return text;
            }
        }

        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é«˜äº®JSONè¯­æ³•ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼Œæ”¯æŒä»£ç å—å’Œè½¬ä¹‰å­—ç¬¦ï¼‰
        function highlightJSON(text) {
            // è½¬ä¹‰HTMLï¼ˆä½†ä¿ç•™ä»£ç å—ç»“æ„ï¼‰
            let html = escapeHtml(text);
            
            // å¤„ç†ä»£ç å—å†…çš„JSONé«˜äº®
            html = html.replace(/(```json[\s\S]*?```)/g, (codeBlock) => {
                // æå–ä»£ç å—å†…å®¹ï¼ˆä¿ç•™æ¢è¡Œï¼‰
                const fullMatch = codeBlock;
                const content = codeBlock.replace(/```json\s*|\s*```/g, '');
                let highlighted = content;
                
                // é«˜äº®å­—ç¬¦ä¸²å€¼ï¼ˆå¤„ç†è½¬ä¹‰å­—ç¬¦ï¼‰
                // åŒ¹é… "key": "value" ä¸­çš„ value éƒ¨åˆ†
                highlighted = highlighted.replace(/(&quot;[^&quot;:]+&quot;)\s*:\s*(&quot;)([^&quot;]*?)(&quot;)/g, 
                    (match, key, openQuote, value, closeQuote) => {
                        // å¤„ç†è½¬ä¹‰å­—ç¬¦çš„æ˜¾ç¤º
                        const displayValue = value
                            .replace(/\\n/g, '<span style="color: #d7ba7d;">\\n</span>')
                            .replace(/\\t/g, '<span style="color: #d7ba7d;">\\t</span>')
                            .replace(/\\r/g, '<span style="color: #d7ba7d;">\\r</span>')
                            .replace(/\\&quot;/g, '<span style="color: #d7ba7d;">\\&quot;</span>')
                            .replace(/\\\\/g, '<span style="color: #d7ba7d;">\\\\</span>');
                        return '<span style="color: #9cdcfe;">' + key + '</span>: <span style="color: #ce9178;">' + openQuote + displayValue + closeQuote + '</span>';
                    });
                
                // é«˜äº®å…³é”®å­—ï¼ˆtrue, false, nullï¼‰
                highlighted = highlighted.replace(/\b(true|false|null)\b/g, 
                    '<span style="color: #569cd6;">$1</span>');
                
                // é«˜äº®æ•°å­—
                highlighted = highlighted.replace(/\b(\d+\.?\d*)\b/g, 
                    '<span style="color: #b5cea8;">$1</span>');
                
                // é«˜äº®æ‹¬å·
                highlighted = highlighted.replace(/([{}[\]])/g, 
                    '<span style="color: #d4d4d4; font-weight: bold;">$1</span>');
                
                // é«˜äº®é€—å·å’Œå†’å·ï¼ˆä¸åœ¨å­—ç¬¦ä¸²ä¸­ï¼‰
                highlighted = highlighted.replace(/([,:])/g, 
                    '<span style="color: #d4d4d4;">$1</span>');
                
                return '```json\n' + highlighted + '\n```';
            });
            
            return html;
        }

        // æ·»åŠ è¾“å‡ºè¡Œ
        function addOutputLine(line, type = 'info') {
            const container = document.getElementById('output-container');
            const lineEl = document.createElement('div');
            lineEl.className = `output-line ${type}`;
            
            // å¤„ç†JSONå†…å®¹
            let processedLine = line;
            
            // å…ˆæ ¼å¼åŒ–JSON
            processedLine = formatJSON(processedLine);
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«JSONä»£ç å—æˆ–JSONå¯¹è±¡/æ•°ç»„
            const hasJSON = /```json|[\{\[]/.test(processedLine);
            
            if (hasJSON) {
                // ä½¿ç”¨innerHTMLæ¥æ˜¾ç¤ºæ ¼å¼åŒ–çš„JSONï¼Œå¹¶æ·»åŠ è¯­æ³•é«˜äº®
                lineEl.innerHTML = highlightJSON(processedLine);
            } else {
                // æ™®é€šæ–‡æœ¬ä½¿ç”¨textContentï¼ˆæ›´å®‰å…¨ï¼‰
                lineEl.textContent = processedLine;
            }
            
            container.appendChild(lineEl);
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            const badge = document.getElementById('status-badge');
            badge.className = `status-badge status-${status}`;
            badge.textContent = text;
        }

        // å¯åŠ¨ä»»åŠ¡
        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // æ”¶é›†æœåŠ¡åœ°å€ï¼ˆå¦‚æœæ²¡æœ‰å¡«å†™ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼‰
            const serviceInputs = document.querySelectorAll('.service-input');
            const services = Array.from(serviceInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');

            // æ”¶é›†è¡¨å•æ•°æ®ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
            const formData = {
                input_file: document.getElementById('input_file').value.trim(),
                output: document.getElementById('output').value.trim(),
                services: services.length > 0 ? services : ['http://localhost:6466/v1'],
                model: document.getElementById('model').value.trim() || '/data/kaipeng/model/Qwen/Qwen3-235B-A22B-Instruct-2507',
                batch_size: document.getElementById('batch_size').value || '16',
                max_concurrent: document.getElementById('max_concurrent').value || '16',
                min_score: document.getElementById('min_score').value || '10',
                task_type: document.getElementById('task_type').value || 'general',
                variants_per_sample: document.getElementById('variants_per_sample').value || '3',
                data_rounds: document.getElementById('data_rounds').value || '10',
                retry_times: document.getElementById('retry_times').value || '3',
                special_prompt: document.getElementById('special_prompt').value.trim() || '',
                directions: document.getElementById('directions').value.trim() || 'ä¿¡ç”¨å¡å¹´è´¹ è‚¡ç¥¨çˆ†ä»“ åŸºé‡‘èµå›'
            };

            // éªŒè¯å¿…å¡«å­—æ®µï¼ˆåªæœ‰è¾“å…¥è¾“å‡ºæ–‡ä»¶æ˜¯å¿…å¡«çš„ï¼‰
            if (!formData.input_file) {
                showAlert('è¯·å¡«å†™è¾“å…¥æ–‡ä»¶è·¯å¾„');
                return;
            }
            if (!formData.output) {
                showAlert('è¯·å¡«å†™è¾“å‡ºæ–‡ä»¶è·¯å¾„');
                return;
            }

            try {
                // ç¦ç”¨è¡¨å•
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;

                // æ¸…ç©ºè¾“å‡º
                document.getElementById('output-container').innerHTML = '';
                document.getElementById('progress-section').classList.add('active');
                updateStatus('running', 'è¿è¡Œä¸­');

                // å‘é€å¯åŠ¨è¯·æ±‚
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'å¯åŠ¨ä»»åŠ¡å¤±è´¥');
                }

                currentTaskId = result.task_id;
                addOutputLine(`ä»»åŠ¡å·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ${currentTaskId}`, 'success');

                // å¼€å§‹ç›‘å¬è¿›åº¦
                startProgressListener(currentTaskId);

            } catch (error) {
                showAlert(error.message);
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
            }
        });

        // å¼€å§‹ç›‘å¬è¿›åº¦
        function startProgressListener(taskId) {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource(`/api/progress/${taskId}`);

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'output') {
                    addOutputLine(data.line);
                } else if (data.type === 'finished') {
                    eventSource.close();
                    eventSource = null;

                    if (data.return_code === 0) {
                        updateStatus('finished', 'å·²å®Œæˆ');
                        addOutputLine('\nâœ… ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼', 'success');
                        showAlert('ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼', 'success');
                    } else {
                        updateStatus('error', 'æ‰§è¡Œå¤±è´¥');
                        addOutputLine(`\nâŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¿”å›ç : ${data.return_code}`, 'error');
                        showAlert(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¿”å›ç : ${data.return_code}`);
                    }

                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                    currentTaskId = null;
                }
            };

            eventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                if (eventSource.readyState === EventSource.CLOSED) {
                    eventSource = null;
                }
            };
        }

        // åœæ­¢ä»»åŠ¡
        document.getElementById('stop-btn').addEventListener('click', async () => {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`/api/stop/${currentTaskId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                    updateStatus('error', 'å·²åœæ­¢');
                    addOutputLine('\nâ¹ï¸ ä»»åŠ¡å·²åœæ­¢', 'error');
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                    currentTaskId = null;
                } else {
                    showAlert('åœæ­¢ä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                showAlert('åœæ­¢ä»»åŠ¡æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        });

        // åˆå§‹åŒ–
        updateRemoveButtons();

        // è‡ªåŠ¨å˜æ¢è¾“å‡ºæ–‡ä»¶è·¯å¾„
        document.getElementById('input_file').addEventListener('input', function(e) {
            const inputPath = e.target.value;
            const outputEl = document.getElementById('output');
            
            // å¦‚æœè¾“å…¥è·¯å¾„ä¸­åŒ…å« input_file/ï¼Œåˆ™è‡ªåŠ¨æ›¿æ¢ä¸º output_file/
            if (inputPath.includes('input_file/')) {
                const outputPath = inputPath.replace('input_file/', 'output_file/');
                outputEl.value = outputPath;
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
        async function checkActiveTask() {
            try {
                const response = await fetch('/api/active_task');
                const result = await response.json();
                
                if (result.success && result.task_id) {
                    currentTaskId = result.task_id;
                    
                    // å¡«å……è¡¨å•å‚æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    if (result.params) {
                        for (const [key, value] of Object.entries(result.params)) {
                            const el = document.getElementById(key);
                            if (el) {
                                if (key === 'services') {
                                    // å¤„ç†æœåŠ¡åˆ—è¡¨
                                    const container = document.getElementById('services-container');
                                    container.innerHTML = '';
                                    value.forEach(svc => {
                                        const newItem = document.createElement('div');
                                        newItem.className = 'service-item';
                                        newItem.innerHTML = `
                                            <input type="text" class="service-input" value="${svc}">
                                            <button type="button" class="btn-remove-service" onclick="removeService(this)">åˆ é™¤</button>
                                        `;
                                        container.appendChild(newItem);
                                    });
                                    updateRemoveButtons();
                                } else {
                                    el.value = value;
                                }
                            }
                        }
                    }

                    // æ›´æ–°UIçŠ¶æ€
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    document.getElementById('progress-section').classList.add('active');
                    updateStatus('running', 'æ­£åœ¨æ¢å¤ä»»åŠ¡è§†å›¾...');
                    
                    addOutputLine(`æ­£åœ¨æ¢å¤ä»»åŠ¡è§†å›¾ (ID: ${currentTaskId})...`, 'info');
                    
                    // å¼€å§‹ç›‘å¬è¿›åº¦
                    startProgressListener(currentTaskId);
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ´»è·ƒä»»åŠ¡å¤±è´¥:', error);
            }
        }

        checkActiveTask();

        // åŠ è½½ä»»åŠ¡ç±»å‹åˆ—è¡¨
        async function loadTaskTypes() {
            try {
                const response = await fetch('/api/task_types');
                const result = await response.json();
                
                if (result.success && result.types) {
                    const select = document.getElementById('task_type');
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    select.innerHTML = '';
                    
                    // æ·»åŠ ä»åç«¯è·å–çš„é€‰é¡¹
                    result.types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        if (type === 'general') {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡ç±»å‹å¤±è´¥:', error);
            }
        }

        loadTaskTypes();
    </script>
</body>
</html>

